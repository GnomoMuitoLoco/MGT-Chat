name: Notificar Discord com commits

on:
  push:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Enviar commits para o Discord
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          BRANCH_URL="https://github.com/${GITHUB_REPOSITORY}/tree/${BRANCH_NAME}"
          COUNT=$(jq '.commits | length' $GITHUB_EVENT_PATH)
          AUTHOR="${GITHUB_ACTOR}"
          AVATAR_URL="https://github.com/${AUTHOR}.png"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Monta os commits com links e formata√ß√£o
          COMMIT_LINES=$(jq -r --arg repo "${GITHUB_REPOSITORY}" '.commits[] | "[`\(.id[0:7])`](https://github.com/" + $repo + "/commit/" + .id) \(.message) ‚Äî \(.author.name)"' $GITHUB_EVENT_PATH)
          COMMITS=$(echo "$COMMIT_LINES" | awk '{print $0 "\\n"}' | tr -d '\n')

          curl -X POST -H "Content-Type: application/json" \
          -d "{
            \"username\": \"GitHub Bot\",
            \"avatar_url\": \"https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png\",
            \"embeds\": [{
              \"title\": \"üì¢ Atualiza√ß√£o no reposit√≥rio\",
              \"color\": 7506394,
              \"author\": {
                \"name\": \"${AUTHOR}\",
                \"url\": \"https://github.com/${AUTHOR}\",
                \"icon_url\": \"${AVATAR_URL}\"
              },
              \"fields\": [
                { \"name\": \"üßë‚Äçüíª Autor\", \"value\": \"${AUTHOR}\", \"inline\": true },
                { \"name\": \"üì¶ Reposit√≥rio\", \"value\": \"${GITHUB_REPOSITORY}\", \"inline\": true },
                { \"name\": \"üåø Branch\", \"value\": \"[${BRANCH_NAME}](${BRANCH_URL})\", \"inline\": true },
                { \"name\": \"üìå ${COUNT} novo(s) commit(s)\", \"value\": \"${COMMITS}\" }
              ],
              \"timestamp\": \"${TIMESTAMP}\"
            }]
          }" ${{ secrets.DISCORD_WEBHOOK }}
